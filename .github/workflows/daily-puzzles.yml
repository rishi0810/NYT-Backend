name: Daily Puzzle Gen

on:
  schedule:
    # Runs at minute 0 past hour 0, 8, and 16 (Every 8 hours)
    - cron: '0 */8 * * *'
  # Allows manual triggering
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Get the code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Node environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install dependencies
      - name: Install Dependencies
        run: npm ci

      # 4. Generate Puzzles
      - name: Generate Puzzles
        run: node generate-puzzles.js
        env:
          BASE_URL_NEW: ${{ secrets.BASE_URL_NEW }}
          BASE_URL_OLD: ${{ secrets.BASE_URL_OLD }}

      # 5. Commit and Push the new JSONs
      - name: Commit and Push
        run: |
          git config --global user.name "Rishi Raj"
          git config --global user.email "rishi.1003raj@gmail.com"
          
          # Force add the static files in case they are gitignored
          git add -f static/*.json
          
          # Only commit if something changed
          if [[ -n $(git status -s) ]]; then
            git commit -m "Daily Puzzle Update [skip ci]"
            git push origin main
            echo "✅ Pushed new puzzles to repo"
          else
            echo "⚠️ No changes detected in puzzles."
          fi

      # 6. Purge jsDelivr Cache
      - name: Purge jsDelivr Cache
        run: |
          files=(
            "wordle.json"
            "strands.json"
            "connections.json"
            "spellingbee.json"
            "letterboxd.json"
            "sudoku.json"
          )
          
          # Explicitly using the repo and branch provided
          repo="rishi0810/NYT-Backend"
          branch="main"
          
          for file in "${files[@]}"; do
            echo "Purging $file..."
            curl -I "https://purge.jsdelivr.net/gh/$repo@$branch/static/$file"
          done
